{% extends "base.html" %}

{% block content %}
<div class="container py-5">
   <!-- Page title + mentee action -->
<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
    <div>
        <h1 class="mentora-page-title mb-1">My Sessions</h1>
        <p class="text-muted mb-0">{{ role_label }}</p>
    </div>

    {% if user.is_authenticated and user.profile.role == "MENTEE" %}
        <a href="{% url 'mentor_list' %}" class="btn btn-mentora-primary">
            + Request New Session
        </a>
    {% endif %}
</div>
    <!-- Glass panel around the table -->
    <div class="mentora-panel">
        {% if sessions %}
            <div class="table-responsive">
                <table class="table table-borderless align-middle mentora-table mb-0">
                    <thead>
                        <tr>
                            <th>Topic</th>
                            <th>Mentor</th>
                            <th>Mentee</th>
                            <th>Scheduled At</th>
                            <th class="text-end">Status / Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in sessions %}
                            <tr>
                                <td><strong>{{ s.topic }}</strong></td>
                                <td>{{ s.mentor.display_name }}</td>
                                <td>{{ s.mentee.display_name }}</td>
                                <td>
                                    {% if s.scheduled_at %}
                                        {{ s.scheduled_at|date:"M d, Y, g:i a" }}
                                    {% else %}
                                        <span class="text-muted">Scheduled session</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">

                                    {# Status badge #}
                                    {% if s.status == "CONFIRMED" %}
                                        <span class="badge bg-success-subtle">Confirmed</span>
                                    {% elif s.status == "CANCELLED" %}
                                        <span class="badge bg-danger-subtle">Cancelled</span>
                                    {% elif s.status == "COMPLETED" %}
                                        <span class="badge bg-secondary-subtle">Completed</span>
                                    {% else %}
                                        <span class="badge bg-warning-subtle">Pending</span>
                                    {% endif %}

                                    {# Mentor: Accept / Decline when PENDING #}
                                    {% if user.profile.role == "MENTOR" and s.status == "PENDING" %}
                                        <form method="post"
                                              action="{% url 'update_session_status' s.id 'CONFIRMED' %}"
                                              style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-mentora-primary btn-sm ms-2">
                                                Accept
                                            </button>
                                        </form>

                                        <form method="post"
                                              action="{% url 'update_session_status' s.id 'CANCELLED' %}"
                                              style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger ms-1">
                                                Decline
                                            </button>
                                        </form>

                                        <a href="#" class="btn btn-mentora-outline btn-sm ms-2">
                                            Reschedule
                                        </a>
                                    {% endif %}

                                    {# Mentor: reschedule CONFIRMED sessions #}
                                    {% if user.profile.role == "MENTOR" and s.status == "CONFIRMED" %}
                                        <a href="{% url 'reschedule_session' s.id %}"
                                           class="btn btn-sm btn-outline-light ms-2">
                                            Reschedule
                                        </a>
                                    {% endif %}

                                    {# Mentee: message when pending #}
                                    {% if user.profile.role == "MENTEE" and s.status == "PENDING" %}
                                        <span class="text-muted ms-2">
                                            (Awaiting mentor approval)
                                        </span>
                                    {% endif %}

                                    {# Mentee: Cancel when Pending or Confirmed #}
                                    {% if user.profile.role == "MENTEE" and s.status == "PENDING" %}
                                        <form method="post"
                                              action="{% url 'cancel_session' s.id %}"
                                              style="display:inline;">
                                            {% csrf_token %}
                                           <button type="submit" class="btn btn-mentora-danger btn-sm ms-2">
                                                Cancel
                                            </button>
                                        </form>
                                    {% endif %}

                                    {% if user.profile.role == "MENTEE" and s.status == "CONFIRMED" %}
                                        <form method="post"
                                              action="{% url 'cancel_session' s.id %}"
                                              style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit"
                                                    class="btn btn-sm btn-outline-danger ms-2">
                                                Cancel
                                            </button>
                                        </form>
                                    {% endif %}

                                    {# Mentee: Leave review for completed sessions without a review #}
                                    {% if user.profile.role == "MENTEE" and s.status == "COMPLETED" and not s.review %}
                                        <a href="{% url 'leave_review' s.id %}"
                                           class="btn btn-sm btn-warning ms-2">
                                            Leave review
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted mb-0">
                You have no sessions yet.
            </p>
        {% endif %}
    </div>
</div>
{% endblock %}
