{% extends "base.html" %}

{% block content %}
<div class="container mt-4" style="max-width: 800px;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Messages</h1>

    {% if contacts %}
      <!-- + New Message button -->
      <button class="btn btn-primary btn-sm"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#newMessageCollapse"
              aria-expanded="false"
              aria-controls="newMessageCollapse">
        + New Message
      </button>
    {% endif %}
  </div>

  <!-- New message contact picker -->
  {% if contacts %}
    <div class="collapse mb-3" id="newMessageCollapse">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title mb-3">
            {% if user.profile.role == "MENTEE" %}
              Mentors you follow
            {% else %}
              Mentees who follow you
            {% endif %}
          </h5>

          <ul class="list-unstyled mb-0">
            {% for c in contacts %}
              <li class="d-flex justify-content-between align-items-center mb-2">
                <a href="{% url 'conversation' c.id %}">
                  {{ c.display_name }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Existing conversations (one row per partner) -->
  {% if threads %}
    <ul class="list-group mb-4">
      {% for t in threads %}
        <li class="list-group-item">
          <a href="{% url 'conversation' t.other.id %}">
            {{ t.other.display_name }}
          </a>
          <span class="text-muted small ms-2">
            {{ t.sent_at|date:"M d, Y, g:i a" }}
          </span>
          <div class="small text-muted">
            {{ t.content|truncatechars:80 }}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="mb-4">No messages yet.</p>
  {% endif %}

  <!-- ===================== -->
  <!-- Notifications section -->
  <!-- ===================== -->
  <div class="mt-2">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Notifications</h5>

      <div class="d-flex align-items-center gap-2">
        {% if unread_count and unread_count > 0 %}
          <span class="badge bg-primary">{{ unread_count }} new</span>
        {% endif %}

        {% if notifications %}
          <form method="post" action="{% url 'clear_notifications' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Delete all notifications?');">
              Clear all
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-body p-0">
        {% if notifications %}
          <ul class="list-group list-group-flush">
            {% for n in notifications %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">
                    {{ n.title }}
                    {% if not n.is_read %}
                      <span class="badge bg-success ms-2">new</span>
                    {% endif %}
                  </div>
                  <div class="small text-muted">
                    {{ n.message }}
                  </div>
                </div>

                <form method="post" action="{% url 'delete_notification' n.id %}">
                  {% csrf_token %}
                  <button type="submit"
                          class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Delete this notification?');">
                    Delete
                  </button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="p-3 text-muted">
            No notifications yet.
          </div>
        {% endif %}
      </div>
    </div>
  </div>


</div>
{% endblock %}
